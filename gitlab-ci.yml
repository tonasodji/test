analyze:
  variables:
    PROJECT_PATH: "tools/${CI_PROJECT_NAME}"
    RELEASE_BRANCH: "master"
    ECD_DIR: "/home/eclair-gitlab/gitlab/${CI_PROJECT_PATH}/${CI_JOB_ID}"
    ECD_FILE: "${ECD_DIR}/PROJECT.ecd"
    LAST_ECD_DIR: "/home/eclair-gitlab/gitlab/$CI_PROJECT_PATH/last_$CI_COMMIT_BRANCH"
  interruptible: true
  script:
    - git clone -b "${RELEASE_BRANCH}" --depth 1 https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}:8444/${PROJECT_PATH}.git .gitlab
    # Prepare for build
    - .gitlab/prepare.sh
    # Analyze the project
    - .gitlab/analyze.sh openssh
    # Make the directory for the ECLAIR project database
    - ssh eclair-gitlab@localhost "mkdir -p ${ECD_DIR} && rm -f ${LAST_ECD_DIR} && ln -s ${ECD_DIR} ${LAST_ECD_DIR}"
    # Copy the project database
    - scp ECLAIR/out/PROJECT.ecd eclair-gitlab@localhost:${ECD_FILE}
    # Publish the ECLAIR report link
    - echo "https://eclairit.com:3787/fs/home/eclair-gitlab/gitlab/$CI_PROJECT_PATH/$CI_JOB_ID/PROJECT.ecd"
    # Create the ECLAIR badge
    - anybadge --label=ECLAIR --value=default --file=ECLAIR/badge.svg
  artifacts:
    paths:
      - ECLAIR/out
      - ECLAIR/badge.svg
    reports:
      codequality: ECLAIR/gl-code-quality-report.json
